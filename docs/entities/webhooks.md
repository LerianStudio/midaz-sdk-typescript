# Working with Webhooks

This guide explains how to work with webhooks using the Midaz SDK.

## What is a Webhook?

In the Midaz financial platform, webhooks allow you to receive real-time notifications about events that occur in your account. Instead of polling the API for changes, webhooks push notifications to your application when events happen.

## Webhook Model

The Webhook model has the following structure:

```typescript
interface Webhook {
  id: string;
  url: string;
  organizationId: string;
  status: Status;
  events: string[];
  secret: string;
  createdAt: string;
  updatedAt: string;
  metadata?: Record<string, any>;
}
```

## Creating Webhooks

### Using the Builder Pattern

The recommended way to create webhooks is using the builder pattern through the `createWebhookBuilder` function:

```typescript
import { createWebhookBuilder } from 'midaz-sdk';

// Create a webhook input using the builder
const webhookInput = createWebhookBuilder('https://example.com/webhooks')
  .withEvents([
    'transaction.created',
    'transaction.updated',
    'account.created',
    'account.updated'
  ])
  .withMetadata({ 
    description: 'Production webhook endpoint',
    version: '1.0'
  })
  .build();

// Create the webhook
const webhook = await client.entities.webhooks.createWebhook(
  organizationId,
  webhookInput
);
```

Note that:
- The `createWebhookBuilder` function requires the `url` parameter as this is a required field
- The `status` field is set in the model but not included in the output of the builder
- The webhook secret is generated by the API and returned in the response
- Additional properties can be set using the chainable `with*` methods

## Retrieving Webhooks

### Get a Specific Webhook

```typescript
// Get a specific webhook by ID
const webhook = await client.entities.webhooks.getWebhook(
  organizationId,
  webhookId
);

console.log(`Webhook: ${webhook.url} (${webhook.id})`);
console.log(`Events: ${webhook.events.join(', ')}`);
```

### List Webhooks

```typescript
// List webhooks with pagination
const webhookList = await client.entities.webhooks.listWebhooks(
  organizationId,
  { limit: 50, offset: 0 }
);

console.log(`Total webhooks: ${webhookList.total}`);
for (const webhook of webhookList.data) {
  console.log(`- ${webhook.url} (${webhook.id})`);
  console.log(`  Events: ${webhook.events.join(', ')}`);
}
```

To handle pagination for large lists, use:

```typescript
import { processPaginatedResults } from 'midaz-sdk/util/data';

// Get all webhooks across pages
const allWebhooks = await processPaginatedResults(
  (options) => client.entities.webhooks.listWebhooks(organizationId, options)
);
```

## Updating Webhooks

```typescript
// Update a webhook
const updatedWebhook = await client.entities.webhooks.updateWebhook(
  organizationId,
  webhookId,
  {
    url: 'https://example.com/updated-webhooks',
    events: [
      ...webhook.events,
      'asset.created',
      'asset.updated'
    ],
    metadata: {
      ...webhook.metadata,
      description: 'Updated production webhook endpoint',
      lastUpdated: new Date().toISOString()
    }
  }
);
```

## Deleting Webhooks

```typescript
// Delete a webhook
await client.entities.webhooks.deleteWebhook(
  organizationId,
  webhookId
);

console.log(`Webhook ${webhookId} deleted`);
```

## Rotating Webhook Secrets

To update the webhook secret for security purposes:

```typescript
// Rotate the webhook secret
const updatedWebhook = await client.entities.webhooks.rotateWebhookSecret(
  organizationId,
  webhookId
);

console.log(`Webhook secret rotated. New secret: ${updatedWebhook.secret}`);
```

## Verifying Webhook Signatures

When receiving a webhook, you should verify the signature to ensure it's legitimate:

```typescript
import { verifyWebhookSignature } from 'midaz-sdk/util/webhooks';

// Express.js webhook handler example
app.post('/webhooks', express.raw({ type: 'application/json' }), (req, res) => {
  const payload = req.body.toString();
  const signature = req.headers['x-midaz-signature'];
  const webhookSecret = 'your-webhook-secret';
  
  // Verify the signature
  const isValid = verifyWebhookSignature(payload, signature, webhookSecret);
  
  if (!isValid) {
    console.error('Invalid webhook signature');
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // Process the webhook
  const event = JSON.parse(payload);
  console.log(`Received webhook event: ${event.type}`);
  
  // Handle different event types
  switch (event.type) {
    case 'transaction.created':
      handleTransactionCreated(event.data);
      break;
    case 'account.updated':
      handleAccountUpdated(event.data);
      break;
    // Handle other event types...
  }
  
  res.status(200).json({ received: true });
});
```

## Error Handling

Use enhanced recovery for critical operations:

```typescript
import { withEnhancedRecovery } from 'midaz-sdk/util';

// Create a webhook with enhanced recovery
const result = await withEnhancedRecovery(
  () => client.entities.webhooks.createWebhook(
    organizationId,
    webhookInput
  )
);

if (result.success) {
  const webhook = result.data;
  console.log(`Webhook created: ${webhook.url} (${webhook.id})`);
  console.log(`Webhook secret: ${webhook.secret} (store securely)`);
} else {
  console.error(`Failed to create webhook: ${result.error.message}`);
}
```

## Best Practices

1. **Use the Builder Pattern**
   Always use the `createWebhookBuilder` function to create webhook inputs, as it ensures all required fields are provided and validation can occur.

2. **Store Webhook Secrets Securely**
   The webhook secret is used to verify the authenticity of webhook requests. Store it securely and never expose it in client-side code.

3. **Always Verify Signatures**
   Always verify webhook signatures to ensure they are legitimate and haven't been tampered with.

4. **Handle Webhook Events Idempotently**
   Design your webhook handlers to be idempotent, as the same event might be sent multiple times in case of delivery issues.

5. **Respond Quickly**
   Webhook handlers should respond quickly (within seconds) to acknowledge receipt. Process events asynchronously if needed.

6. **Implement Error Handling**
   Handle potential errors in your webhook processing to ensure no events are missed.

7. **Use Appropriate Event Types**
   Only subscribe to the events you need to reduce unnecessary traffic.

## Example: Complete Webhook Management

```typescript
// Webhook management example
async function manageWebhooks(client, organizationId) {
  try {
    // Create a new webhook
    const webhookInput = createWebhookBuilder('https://example.com/midaz-webhooks')
      .withEvents([
        'transaction.created',
        'transaction.updated',
        'account.created',
        'account.updated'
      ])
      .withMetadata({ 
        environment: 'production',
        version: '1.0',
        description: 'Primary webhook endpoint for transaction and account events'
      })
      .build();

    const webhook = await client.entities.webhooks.createWebhook(
      organizationId,
      webhookInput
    );
    console.log(`Created webhook: ${webhook.url} (${webhook.id})`);
    console.log(`Webhook secret: ${webhook.secret}`);
    console.log(`Subscribed events: ${webhook.events.join(', ')}`);

    // Get the webhook details
    const retrievedWebhook = await client.entities.webhooks.getWebhook(
      organizationId,
      webhook.id
    );
    console.log(`Retrieved webhook: ${retrievedWebhook.url}`);

    // Update the webhook
    const updatedWebhook = await client.entities.webhooks.updateWebhook(
      organizationId,
      webhook.id,
      {
        events: [
          ...webhook.events,
          'asset.created',
          'asset.updated'
        ],
        metadata: {
          ...webhook.metadata,
          lastUpdated: new Date().toISOString()
        }
      }
    );
    console.log(`Updated webhook: ${updatedWebhook.url}`);
    console.log(`Updated events: ${updatedWebhook.events.join(', ')}`);

    // List all webhooks
    const webhooks = await client.entities.webhooks.listWebhooks(
      organizationId,
      { limit: 10 }
    );
    console.log(`Listed ${webhooks.data.length} webhooks`);

    // Rotate the webhook secret
    const rotatedWebhook = await client.entities.webhooks.rotateWebhookSecret(
      organizationId,
      webhook.id
    );
    console.log(`Rotated webhook secret: ${rotatedWebhook.secret}`);

    return {
      created: webhook,
      updated: updatedWebhook,
      rotated: rotatedWebhook,
      webhooks: webhooks.data
    };
  } catch (error) {
    console.error(`Webhook management error: ${error.message}`);
    throw error;
  }
}
```
